# v2.7 UI Testing Guide

**Version**: 2.7.0  
**Feature**: Staleness Detection & Global Analyze  
**Status**: Ready for Testing

---

## 🎯 What to Test

The new UI integration brings the v2.7 data strategy to life with visible feedback and user controls.

---

## 📋 Test Scenarios

### Scenario 1: First Visit (Never Analyzed)

**Steps**:
1. Open dev server: `http://localhost:3000`
2. Click on any existing job
3. **Expected**: Blue banner appears with 🌟 "Ready to Analyze"
4. **Message**: "No analysis run yet - click Analyze to get started"

**Banner Should Show**:
- Blue background (`bg-blue-50`)
- "Ready to Analyze" heading
- "Analyze Now" button

---

### Scenario 2: Upload Document (Major Change)

**Steps**:
1. On job detail page, click "View Attachments"
2. Upload a resume or JD
3. Close attachments modal
4. **Expected**: Orange banner appears with ⚠️ "Major Changes Detected"
5. **Message**: "Key documents changed - re-analysis strongly recommended"
6. **Changed artifacts**: Shows "resume" or "jd" in small text

**Banner Should Show**:
- Orange background (`bg-orange-50`)
- "Major Changes Detected" heading
- "Changed: resume" (or "jd")
- "Analyze Now" button

---

### Scenario 3: Click Analyze Now

**Steps**:
1. Click "Analyze Now" button
2. **Expected**: Button shows loading state
3. **Loading state**:
   - Animated spinner icon
   - Text changes to "Analyzing..."
   - Button disabled (gray background)
4. **After ~2-5 seconds**: Analysis completes
5. **Expected**: Banner disappears or updates to "fresh" state

**During Analysis**:
- Button disabled
- Spinner animates
- Can't click again

**After Success**:
- Banner disappears (analysis is fresh)
- No error message shown

---

### Scenario 4: Rate Limiting (Spam Prevention)

**Steps**:
1. Click "Analyze Now"
2. Wait for completion
3. **Immediately** click "Analyze Now" again
4. **Expected**: Error message appears
5. **Error says**: "Please wait X seconds between analyses"

**Error Display**:
- Red background box below button
- Clear error message
- Error disappears on next attempt after cooldown

---

### Scenario 5: Analysis Failure

**Steps**:
1. Stop the dev server: `Ctrl+C`
2. Restart: `npm run dev`
3. Navigate to a job that has attachments but no extracted text
4. Click "Analyze Now"
5. **Expected**: Error message appears

**Error Handling**:
- Error message shows in red box
- Button re-enables
- Can retry after fixing issue

---

### Scenario 6: Staleness Auto-Detection

**Steps**:
1. Visit a job (wait for staleness check)
2. Open attachments modal
3. Mark a different resume version as active
4. Close modal
5. **Expected**: Staleness re-checks automatically
6. **Banner updates**: If changed significantly, shows orange banner

**Auto-Detection Triggers**:
- On page load
- After attachment count changes
- After marking different version active

---

## 🎨 Visual Reference

### Banner States

#### Never Analyzed (Blue)
```
╔══════════════════════════════════════════════════╗
║ 🌟 Ready to Analyze                              ║
║                                                  ║
║ No analysis run yet - click Analyze to get      ║
║ started                                          ║
║                                     [Analyze Now]║
╚══════════════════════════════════════════════════╝
```

#### Major Changes (Orange)
```
╔══════════════════════════════════════════════════╗
║ ⚠️  Major Changes Detected                       ║
║                                                  ║
║ Key documents changed - re-analysis strongly     ║
║ recommended                                      ║
║ Changed: resume, jd                              ║
║                                     [Analyze Now]║
╚══════════════════════════════════════════════════╝
```

#### Minor Changes (Yellow)
```
╔══════════════════════════════════════════════════╗
║ ℹ️  Updates Available                            ║
║                                                  ║
║ Minor updates detected - consider re-analyzing   ║
║                                                  ║
║                                     [Analyze Now]║
╚══════════════════════════════════════════════════╝
```

#### Loading State
```
╔══════════════════════════════════════════════════╗
║ 🌟 Ready to Analyze                              ║
║                                                  ║
║ No analysis run yet - click Analyze to get       ║
║ started                                          ║
║                          [⏳ Analyzing...]        ║
╚══════════════════════════════════════════════════╝
```

#### Error State
```
╔══════════════════════════════════════════════════╗
║ ⚠️  Major Changes Detected                       ║
║                                                  ║
║ Key documents changed - re-analysis strongly     ║
║ recommended                                      ║
║ ┌────────────────────────────────────────────┐  ║
║ │ ❌ Please wait 25 seconds between analyses │  ║
║ └────────────────────────────────────────────┘  ║
║                                     [Analyze Now]║
╚══════════════════════════════════════════════════╝
```

---

## 🔍 Technical Verification

### Check API Calls (Browser DevTools)

**Open DevTools → Network tab**:

1. **On page load**:
   - `GET /api/jobs/{id}/check-staleness`
   - Response: `{ isStale: true, severity: "never_analyzed", ... }`

2. **On analyze click**:
   - `POST /api/jobs/{id}/analyze-all`
   - Response: `{ success: true, message: "...", results: {...} }`

3. **After analysis**:
   - `GET /api/jobs/{id}/check-staleness` (auto-refresh)
   - Response: `{ isStale: false, severity: "fresh", ... }`

### Check Console Logs

**Look for**:
- `🔄 Ensuring variants exist for job {id}...`
- `📎 Found X active attachments`
- `✅ Variant extraction complete`

---

## 🐛 Known Issues to Watch For

### Issue 1: Banner Not Appearing
**Symptom**: No banner shows on job page  
**Cause**: No attachments uploaded  
**Fix**: Upload at least one resume or JD

### Issue 2: Analyze Button Doesn't Work
**Symptom**: Clicking does nothing  
**Cause**: API endpoint not responding  
**Check**: Browser console for errors  
**Fix**: Ensure server is running

### Issue 3: Rate Limit Not Working
**Symptom**: Can click analyze multiple times quickly  
**Cause**: `last_full_analysis_at` not being set  
**Check**: Database with `npm run db:studio`  
**Fix**: Ensure migration 009 ran successfully

---

## ✅ Acceptance Criteria

### Must Have
- [x] Banner appears for stale jobs
- [x] Banner color matches severity (blue/yellow/orange)
- [x] Analyze button triggers POST request
- [x] Loading state shows during analysis
- [x] Rate limiting prevents spam (30s cooldown)
- [x] Banner updates/disappears after success
- [x] Errors display clearly

### Nice to Have
- [ ] Smooth transitions when banner appears/disappears
- [ ] Toast notification on success
- [ ] Progress indicator for long-running analysis
- [ ] "View extracted data" link

---

## 📊 Success Metrics

**User Experience**:
- Banner is noticeable but not intrusive ✓
- Call-to-action is clear ✓
- Loading states prevent confusion ✓
- Errors are actionable ✓

**Technical Performance**:
- Staleness check: <100ms
- Global analyze: <10s (with mock extractors)
- No console errors
- No memory leaks

---

## 🎬 Demo Flow for Stakeholders

1. **Show before state**: Job page without analysis
2. **Point out banner**: "See this blue banner? It tells you analysis is needed"
3. **Click analyze**: "Watch the loading state..."
4. **Show after**: "Banner disappears when fresh"
5. **Upload new resume**: "Watch it detect the change automatically"
6. **Show orange banner**: "Major changes get highlighted"
7. **Try rapid clicking**: "Rate limiting protects from accidental spam"

---

## 🔧 Troubleshooting

### Dev Server Not Starting
```bash
# Kill existing process
lsof -ti:3000 | xargs kill -9

# Restart
npm run dev
```

### Database Out of Sync
```bash
# Re-run migrations
npm run db:migrate

# Check tables exist
npm run db:studio
```

### API Endpoints Not Found
```bash
# Verify files exist
ls app/api/jobs/\[id\]/check-staleness/
ls app/api/jobs/\[id\]/analyze-all/

# Check build
npm run build
```

---

## 📝 Feedback Template

**What worked well**:
- 

**What was confusing**:
- 

**Bugs found**:
- 

**Suggestions**:
- 

---

**Last Updated**: October 15, 2025  
**Tester**: _________  
**Date Tested**: _________  
**Result**: ☐ PASS | ☐ FAIL | ☐ NEEDS WORK

