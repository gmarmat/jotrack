# v2.7 Revised Architecture: Two-Button System

**Date**: October 15, 2025  
**Status**: Design Approved, Ready for Implementation  
**Key Insight**: Separate local extraction from AI variant generation

---

## Core Principle

**DON'T mix local and AI operations in one button.**

Instead: **Two distinct workflows with clear cost boundaries**

---

## The Two-Button System

### Button 1: "Refresh Data" ($0.02-0.05)
**Purpose**: Create/update AI-optimized variants from documents  
**Trigger**: After uploading/toggling documents  
**What happens**:
1. Read raw text (local, free, already done on upload)
2. Send to AI: Extract structured data
3. Get back: Skills, experience, requirements (normalized)
4. Compare to previous variant (AI semantic diff)
5. Show changelog: "Added 3 skills, removed PHP"
6. Determine if change is significant (AI judgment)
7. Update banner if needed

**Location**: Job detail page, shows when raw text exists but no AI variant

### Button 2: "Analyze All" ($0.15-0.30)
**Purpose**: Run full analysis across all sections  
**Trigger**: After AI variants are fresh  
**What happens**:
1. Use existing `ai_optimized` variants (no re-extraction!)
2. Run: Match Score, Skills, Signals, Company Intel, etc.
3. Update fingerprint
4. Mark analysis as fresh

**Location**: Job detail page, shows when AI variants exist

---

## Complete User Flow

```
Step 1: UPLOAD (Local, Free)
User uploads Resume.docx
  ↓
Local: DOCX → plain text (mammoth library)
  ↓
Save as 'raw' variant
  ↓
Show banner: "📄 New document uploaded - click 'Refresh Data' to process"

Step 2: REFRESH DATA (AI, $0.02)
User clicks "Refresh Data" button
  ↓
AI: Extract resume → { skills: [...], experience: [...] }
  ↓
Save as 'ai_optimized' and 'detailed' variants
  ↓
AI: Compare to previous variant
  ↓
AI returns: { 
  similarity: 0.75,
  changes: ["Added AWS skill", "Updated current role", "Removed PHP"],
  significanceLevel: "major"
}
  ↓
Show: "✨ Data refreshed! Changes: +3 skills, 1 role updated"
  ↓
Update banner: "⚠️ Significant changes detected - run 'Analyze All' for updated insights"

Step 3: ANALYZE ALL (AI, $0.20)
User clicks "Analyze All" button
  ↓
Reuse 'ai_optimized' variants (no re-extraction!)
  ↓
Run all section analyses
  ↓
Show: "✅ Analysis complete!"
  ↓
All banners disappear (fresh)
```

---

## Banner States & Button Visibility

### State 1: Fresh Upload (No AI Variants)
```
┌─────────────────────────────────────────────┐
│ 📄 New Document Uploaded                    │
│                                             │
│ Click 'Refresh Data' to extract insights   │
│ with AI (~$0.02)                            │
│                              [Refresh Data] │
└─────────────────────────────────────────────┘

Buttons visible:
- ✅ "Refresh Data" (enabled)
- ❌ "Analyze All" (disabled/hidden - no variants yet)
```

### State 2: AI Variants Fresh, No Analysis
```
┌─────────────────────────────────────────────┐
│ 🌟 Ready to Analyze                         │
│                                             │
│ AI variants are ready. Run full analysis   │
│ for match scores and insights (~$0.20)      │
│                              [Analyze All]  │
└─────────────────────────────────────────────┘

Buttons visible:
- ✅ "Refresh Data" (enabled - can re-extract)
- ✅ "Analyze All" (enabled - variants ready)
```

### State 3: Document Changed (Variants Stale)
```
┌─────────────────────────────────────────────┐
│ ⚠️  Document Changed                         │
│                                             │
│ You've uploaded/toggled a document.         │
│ Click 'Refresh Data' to update AI insights │
│                              [Refresh Data] │
└─────────────────────────────────────────────┘

Buttons visible:
- ✅ "Refresh Data" (enabled, highlighted)
- ⚠️ "Analyze All" (enabled but shows warning: "variants may be outdated")
```

### State 4: Everything Fresh
```
No banner visible

Buttons visible:
- ✅ "Refresh Data" (enabled, subtle)
- ✅ "Analyze All" (enabled, subtle)
```

---

## Database Schema (No Changes Needed!)

Current schema already supports this:

```sql
artifact_variants:
- 'raw' variant: Plain text (local extraction)
- 'ai_optimized': Structured summary (AI extraction) ← Drives "Refresh Data"
- 'detailed': Full extraction (AI)

analysis_state:
- 'pending': No AI variants yet
- 'variants_stale': Document changed, need "Refresh Data"
- 'variants_fresh': AI variants ready, can "Analyze All"
- 'analyzing': Analysis in progress
- 'fresh': Everything up to date
```

---

## API Endpoints

### New: POST /api/jobs/[id]/refresh-variants
**What it does**:
```typescript
1. Get all active attachments
2. For each: Read 'raw' variant
3. Call AI to extract structured data
4. Save as 'ai_optimized' variant
5. If previous variant exists: AI semantic comparison
6. Return changelog and similarity score
```

**Response**:
```json
{
  "success": true,
  "processed": [
    {
      "kind": "resume",
      "filename": "Resume_v3.docx",
      "similarity": 0.75,
      "changes": ["Added AWS skill", "Updated role"],
      "significance": "major"
    }
  ],
  "totalCost": "$0.023",
  "recommendation": "Run 'Analyze All' for updated insights"
}
```

### Existing: POST /api/jobs/[id]/analyze-all
**Updated behavior**:
```typescript
// Now just uses variants, doesn't extract
1. Check if ai_optimized variants exist
2. If not: Error "Run 'Refresh Data' first"
3. If yes: Use variants for all analyses
```

---

## Cost Breakdown

| Action | What Runs | Tokens | Cost |
|--------|-----------|--------|------|
| **Upload Document** | Local DOCX→text | 0 | FREE |
| **Refresh Data** | AI extraction + comparison | 2,500 | $0.02 |
| **Analyze All** | Use cached variants | 3,000 | $0.02 |
| **Full Flow** | Upload + Refresh + Analyze | 5,500 | $0.04 |

**vs Old Approach** (re-extract every time):
- Old: Upload + Analyze = 10,000 tokens = $0.08
- New: Upload + Refresh + Analyze = 5,500 tokens = $0.04
- **Savings**: 50% immediately, 75% on re-analysis

---

## Implementation Checklist

### Phase 1: Local Text Extraction (Free) ✅ DONE
- [x] mammoth for DOCX
- [x] pdf-parse for PDF
- [x] Save as 'raw' variant
- [x] Happens on upload (background)

### Phase 2: "Refresh Data" Button (AI, $0.02)
- [ ] Create POST /api/jobs/[id]/refresh-variants endpoint
- [ ] AI extraction prompts (resume, JD, cover letter)
- [ ] AI comparison logic (semantic diff)
- [ ] Changelog generation
- [ ] Update UI banner with "Refresh Data" button
- [ ] Show cost estimate on button
- [ ] Loading state during refresh

### Phase 3: Update "Analyze All" Button
- [ ] Check for variants before running
- [ ] Show error if variants missing
- [ ] Display cost estimate
- [ ] Update fingerprint logic

### Phase 4: Banner Intelligence
- [ ] "📄 New upload" → Show "Refresh Data"
- [ ] "✨ Variants ready" → Show "Analyze All"
- [ ] "⚠️ Stale" → Show "Refresh Data" highlighted
- [ ] "✅ Fresh" → Hide banners, show subtle buttons

---

## Updated State Machine

```
State: NO_VARIANTS
  Trigger: Upload document
  Banner: "📄 New document uploaded"
  Buttons: [Refresh Data (highlighted)] [Analyze All (disabled)]
  
State: VARIANTS_FRESH
  Trigger: "Refresh Data" completes
  Banner: "🌟 Ready to analyze"
  Buttons: [Refresh Data] [Analyze All (highlighted)]
  
State: VARIANTS_STALE
  Trigger: Toggle version / Upload new doc
  Banner: "⚠️ Document changed"
  Buttons: [Refresh Data (highlighted)] [Analyze All (warning)]
  
State: ANALYSIS_FRESH
  Trigger: "Analyze All" completes
  Banner: None (or "✅ Up to date")
  Buttons: [Refresh Data] [Analyze All]
```

---

## Semantic Change Detection (AI-Based)

When comparing variants, AI prompt:

```typescript
const prompt = `
Compare these two resume variants and determine:
1. Similarity score (0-1)
2. What changed (list of changes)
3. Significance level (major/minor/none)

Old variant:
${JSON.stringify(oldVariant, null, 2)}

New variant:
${JSON.stringify(newVariant, null, 2)}

Return JSON:
{
  "similarity": 0.85,
  "changes": [
    { "type": "added", "category": "skill", "value": "AWS" },
    { "type": "updated", "category": "experience", "field": "current_role" },
    { "type": "removed", "category": "skill", "value": "PHP" }
  ],
  "significance": "major",
  "reasoning": "Added cloud skills and updated current role - material changes to qualifications"
}
`;
```

**Smart Rules**:
- Added/removed skill → Major
- Updated job title → Major
- Typo fix → None
- Reformatting → None
- Added bullet point → Minor

---

## Cost Transparency

Show costs on buttons:
```tsx
<button className="...">
  Refresh Data
  <span className="text-xs opacity-75">~$0.02</span>
</button>

<button className="...">
  Analyze All
  <span className="text-xs opacity-75">~$0.20</span>
</button>
```

---

## Success Metrics

**User Experience**:
- Clear separation of concern (extract vs analyze)
- No surprise AI costs
- Detailed feedback on what changed
- Fewer false positives (AI understands semantics)

**Technical**:
- 50% cost reduction (extract once, analyze many)
- Accurate change detection (AI-based)
- Fast local operations (DOCX→text instant)
- Scalable (variants cached indefinitely)

---

## Next Steps

1. **Implement local text extraction** (mammoth + pdf-parse)
2. **Create "Refresh Data" API endpoint**
3. **Add two-button UI**
4. **AI comparison prompts**
5. **Update staleness logic**
6. **Test full flow**

**Estimated time**: 2-3 hours for complete implementation

---

**Status**: ✅ READY TO IMPLEMENT  
**Next**: Begin Phase 2 (Refresh Data button)

